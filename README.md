# Trace Serverless API Calls with AWS Lambda and AWS X-Ray

This project demonstrates how to trace serverless API calls using AWS Lambda and AWS X-Ray.

## Architecture

Client → API Gateway → Lambda Function (Node.js) → AWS X-Ray

![image](https://github.com/user-attachments/assets/cdf3cf67-7972-4379-899e-84515dc35186)



## Prerequisites

- AWS CLI configured
- AWS account with IAM access
- Node.js installed
- Optional: Postman/cURL to test the API

## Setup Instructions

## 1, Create an IAM Role with X-Ray Permissions

Create a role called LambdaExecutionRole and attach the following policies:

- AWSLambdaBasicExecutionRole
- AWSXRayDaemonWriteAccess

## 2, Create a Lambda Function with X-Ray SDK

Go to the Lambda Console and click Create function.

- Choose Author from scratch.
- Provide a function name (lambda-xray-demo).
- Select Node.js 18.x as the runtime.
- Under Permissions, choose Use an existing role(LambdaExecutionRole)
- Create function.

## 3, Add X-Ray SDK to Your Lambda Function

In your local development environment, create a new directory and initialize a Node.js project:

      #mkdir lambda-xray && cd lambda-xray
      #npm init -y
      #npm install aws-xray-sdk

### 3.1 Create an index.js file with the following content:


      const AWSXRay = require('aws-xray-sdk-core');
      const AWS = AWSXRay.captureAWS(require('aws-sdk'));

      exports.handler = async (event) => {
       const segment = AWSXRay.getSegment(); // Root segment
       const subsegment = segment.addNewSubsegment('custom-subsegment');

       // Simulate a process or downstream call
       await new Promise(resolve => setTimeout(resolve, 100));

       subsegment.close();
       return {
           statusCode: 200,
           body: JSON.stringify({ message: 'X-Ray Tracing Enabled in Lambda!' }),
             };
         };

### 3.2 Zip the contents:

      #zip -r function.zip index.js node_modules

### 3.3 In the Lambda Console, upload the function.zip file to your function.

## 4, Enable X-Ray Tracing for the Lambda Function

- Navigate to your Lambda function.
- Go to the Configuration tab.
- Under Monitoring and operations tools, click Edit.
- Enable Active tracing.
- Click Save.

## 5, Create an API Gateway Trigger

Navigate to the API Gateway Console.
- Click Create API and choose REST API.
- Create the API(lambda-xray-api).
- In the API's Resources section, create a new resource (e.g., /trace).

Under the new resource, create a GET method:
	- Integration type: Lambda Function
	- Lambda Function: lambda-xray-demo

**Deploy the API:**
- Click Actions > Deploy API
- Create a new stage (e.g., prod)
- Note the Invoke URL provided after deployment.

## 6, Test the Setup and View Traces in X-Ray

Use a browser or tools like Postman to send a GET request to the API's Invoke URL (e.g., https://<api-id>.execute-api.<region>.amazonaws.com/prod/trace).

- Navigate to the AWS X-Ray Console.
- View the traces and subsegments generated by your Lambda function.
